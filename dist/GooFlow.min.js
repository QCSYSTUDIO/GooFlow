var GooFunc={getElCoordinate:function(c){var b=c.offsetTop;var a=c.offsetLeft;c=c.offsetParent;while(c){b+=c.offsetTop;a+=c.offsetLeft;c=c.offsetParent}return{top:b,left:a}},mousePosition:function(a){if(!a){a=window.event}if(a.pageX||a.pageY){return{x:a.pageX,y:a.pageY}}return{x:a.clientX+document.documentElement.scrollLeft-document.body.clientLeft,y:a.clientY+document.documentElement.scrollTop-document.body.clientTop}}};function GooFlow(h,l){if(navigator.userAgent.indexOf("MSIE 8.0")>0||navigator.userAgent.indexOf("MSIE 7.0")>0||navigator.userAgent.indexOf("MSIE 6.0")>0){GooFlow.prototype.useSVG=""}else{GooFlow.prototype.useSVG="1"}var g=l.id||h.attr("id");if(!g){console.log("Error! 若id参数没有给出, 则容器必须提供id属性!");return false}this.$id=g;this.$bgDiv=h;this.$bgDiv.addClass("GooFlow");this.$tool=null;this.$head=null;this.$title=null;this.$nodeRemark={};this.$nowType="cursor";this.$lineData={};this.$lineCount=0;this.$nodeData={};this.$nodeCount=0;this.$areaData={};this.$areaCount=0;this.$lineDom={};this.$nodeDom={};this.$areaDom={};this.$max=l.initNum;this.$focus="";this.$cursor="default";this.$editable=l.editable;this.$MainContener=l.MainContener;var b;if(l.width=="auto"){b=this.$bgDiv.parent().width()-2}else{b=l.width-2}var m=l.height-2;var c=0;this.$bgDiv.css({width:b+"px",height:m+"px"});var j="";if(l.haveHead){j="<div class='GooFlow_head'><label title='"+l.initLabelText+"'>"+l.initLabelText+"</label><span></span>";for(var k=0;k<l.headBtns.length;++k){j+="<a href='javascript:void(0)' title='"+(l.headBtnRemarks[k]||l.headBtns[k])+"'>";j+="<i class='fa ico_"+l.headBtns[k]+"'></i></a>"}j+="<span></span></div>";this.$head=$(j);this.$bgDiv.append(this.$head);c=24;this.onBtnNewClick=l.onBtnNewClick;this.onBtnOpenClick=l.onBtnOpenClick;this.onBtnSaveClick=l.onBtnSaveClick;this.onFreshClick=l.onFreshClick;this.onExpandClick=l.onExpandClick;if(l.headBtns){this.$head.on("click",{inthis:this},function(p){if(!p){p=window.event}var n=p.target;if(n.tagName=="DIV"||n.tagName=="SPAN"){return}else{if(n.tagName=="a"){n=n.childNode[0]}}var q=p.data.inthis;var o=$(n).attr("class").match(/ico_\w+/g)[0];switch(o){case"ico_new":if(q.onBtnNewClick!=null){q.onBtnNewClick()}break;case"ico_open":if(q.onBtnOpenClick!=null){q.onBtnOpenClick()}break;case"ico_save":if(q.onBtnSaveClick!=null){q.onBtnSaveClick()}break;case"ico_undo":q.undo();break;case"ico_redo":q.redo();break;case"ico_reload":if(q.onFreshClick!=null){q.onFreshClick()}break;case"ico_expand":if(q.onExpandClick!=null){q.onExpandClick()}break}})}}var e=0;if(l.haveTool){j="<div class='GooFlow_tool'"+(l.haveHead?"":" style='margin-top:3px'")+"><div style='height:"+(m-c-(l.haveHead?7:10))+"px' class='GooFlow_tool_div'></div></div>";this.$bgDiv.append(j);this.$tool=this.$bgDiv.find(".GooFlow_tool div");j="<a href='javascript:void(0)' id='"+this.$id+"_btn_cursor' "+(l.toolBtnRemarks.cursor?"title='"+l.toolBtnRemarks.cursor+"'":"")+"><i class='fa ico_cursor'/></i><a href='javascript:void(0)' id='"+this.$id+"_btn_direct' "+(l.toolBtnRemarks.direct?"title='"+l.toolBtnRemarks.direct+"'":"")+"><i class='fa ico_direct'/></i>";this.$tool.append(j);if(l.toolBtns&&l.toolBtns.length>0){j="<span/>";for(var d=0;d<l.toolBtns.length;d++){j+="<a href='javascript:void(0)' id='"+this.$id+"_btn_"+l.toolBtns[d]+"' "+(l.toolBtnRemarks[l.toolBtns[d]]?"title='"+l.toolBtnRemarks[l.toolBtns[d]]+"'":"")+"><i class='fa ico_"+l.toolBtns[d]+"'/></i></a>"}this.$tool.append(j)}if(l.haveGroup){j="<span/><a href='javascript:void(0)' id='"+this.$id+"_btn_group' "+(l.toolBtnRemarks.group?"title='"+l.toolBtnRemarks.group+"'":"")+"><i class='fa ico_group'/></i>";this.$tool.append(j)}e=31;this.$nowType="cursor";this.$tool.on("click",{inthis:this},function(p){if(!p){p=window.event}var n;switch(p.target.tagName){case"SPAN":return false;case"DIV":return false;case"B":n=p.target.parentNode;break;case"I":n=p.target.parentNode;break;case"A":n=p.target}var o=$(n).attr("id").split("btn_")[1];p.data.inthis.switchToolBtn(o);return false});this.$editable=true}b=b-e-8;m=m-c-(l.haveHead?5:8);var a=l.workWidth;var f=l.workHeight;if(!a){a=b-17}if(!f){f=m-(l.haveHead?20:17)}this.$bgDiv.append("<div class='GooFlow_work' style='width:"+(b)+"px;height:"+(m)+"px;"+(l.haveHead?"":"margin-top:3px")+"'></div>");this.$workArea=$("<div class='GooFlow_work_inner' style='width:"+a+"px;height:"+f+"px'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"});this.$bgDiv.children(".GooFlow_work").append(this.$workArea);this.$draw=null;this.initDraw("draw_"+this.$id,b,m,a,f);this.$group=null;this.initGroup(b,m,a,f);if(this.$editable){this.$workArea.on("click",{inthis:this},function(r){if(!r){r=window.event}if(!r.data.inthis.$editable){return}var p=r.data.inthis.$nowType;if(p=="cursor"){var o=$(r.target);var v=o.prop("tagName");if(v=="svg"||(v=="DIV"&&o.prop("class").indexOf("GooFlow_work")>-1)||v=="LABEL"){r.data.inthis.blurItem()}return}else{if(p=="direct"||p=="group"){return}}var u,s;var q=GooFunc.mousePosition(r),o=GooFunc.getElCoordinate(this);u=q.x-o.left+this.parentNode.scrollLeft;s=q.y-o.top+this.parentNode.scrollTop;r.data.inthis.addNode(r.data.inthis.$id+"_node_"+r.data.inthis.$max,{name:"node_"+r.data.inthis.$max,left:u,top:s,type:r.data.inthis.$nowType});r.data.inthis.$max++});this.$workArea.mousemove({inthis:this},function(r){if(r.data.inthis.$nowType!="direct"){return}var p=$(this).data("lineStart");if(!p){return}var q=GooFunc.mousePosition(r),o=GooFunc.getElCoordinate(this);var u,s;u=q.x-o.left+this.parentNode.scrollLeft;s=q.y-o.top+this.parentNode.scrollTop;var n=document.getElementById("GooFlow_tmp_line");if(GooFlow.prototype.useSVG!=""){n.childNodes[0].setAttribute("d","M "+p.x+" "+p.y+" L "+u+" "+s);n.childNodes[1].setAttribute("d","M "+p.x+" "+p.y+" L "+u+" "+s);if(n.childNodes[1].getAttribute("marker-end")=='url("#arrow2")'){n.childNodes[1].setAttribute("marker-end","url(#arrow3)")}else{n.childNodes[1].setAttribute("marker-end","url(#arrow2)")}}else{n.points.value=p.x+","+p.y+" "+u+","+s}});this.$workArea.mouseup({inthis:this},function(o){if(o.data.inthis.$nowType!="direct"){return}$(this).css("cursor","auto").removeData("lineStart");var n=document.getElementById("GooFlow_tmp_line");if(n){o.data.inthis.$draw.removeChild(n)}});this.initWorkForNode();this.$ghost=$("<div class='rs_ghost'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"});this.$bgDiv.append(this.$ghost);this.$textArea=$("<textarea></textarea>");this.$bgDiv.append(this.$textArea);this.$lineMove=$("<div class='GooFlow_line_move' style='display:none'></div>");this.$workArea.append(this.$lineMove);this.$lineMove.on("mousedown",{inthis:this},function(v){var w=$(this);w.css({"background-color":"#333"});var u=v.data.inthis;var x=GooFunc.mousePosition(v),z=GooFunc.getElCoordinate(u.$workArea[0]);var s,q;s=x.x-z.left+u.$workArea[0].parentNode.scrollLeft;q=x.y-z.top+u.$workArea[0].parentNode.scrollTop;var r=u.$lineMove.position();var o=s-r.left,n=q-r.top;var y=false;document.onmousemove=function(t){if(!t){t=window.event}var p=GooFunc.mousePosition(t);var A=u.$lineMove.position();s=p.x-z.left+u.$workArea[0].parentNode.scrollLeft;q=p.y-z.top+u.$workArea[0].parentNode.scrollTop;if(u.$lineMove.data("type")=="lr"){s=s-o;if(s<0){s=0}else{if(s>u.$workArea.width()){s=u.$workArea.width()}}u.$lineMove.css({left:s+"px"})}else{if(u.$lineMove.data("type")=="tb"){q=q-n;if(q<0){q=0}else{if(q>u.$workArea.height()){q=u.$workArea.height()}}u.$lineMove.css({top:q+"px"})}}y=true};document.onmouseup=function(A){if(y){var t=u.$lineMove.position();if(u.$lineMove.data("type")=="lr"){u.setLineM(u.$lineMove.data("tid"),t.left+3)}else{if(u.$lineMove.data("type")=="tb"){u.setLineM(u.$lineMove.data("tid"),t.top+3)}}}u.$lineMove.css({"background-color":"transparent"});if(u.$focus==u.$lineMove.data("tid")){u.focusItem(u.$lineMove.data("tid"))}document.onmousemove=null;document.onmouseup=null}});this.$lineOper=$("<div class='GooFlow_line_oper' style='display:none'><b class='b_l1'></b><b class='b_l2'></b><b class='b_l3'></b><b class='b_x'></b></div>");this.$workArea.append(this.$lineOper);this.$lineOper.on("click",{inthis:this},function(n){if(!n){n=window.event}if(n.target.tagName!="B"){return}var o=n.data.inthis;var p=$(this).data("tid");switch($(n.target).attr("class")){case"b_x":o.delLine(p);this.style.display="none";break;case"b_l1":o.setLineType(p,"lr");break;case"b_l2":o.setLineType(p,"tb");break;case"b_l3":o.setLineType(p,"sl");break}});this.onItemAdd=l.onItemAdd;this.onItemDel=l.onItemDel;this.onItemMove=l.onItemMove;this.onItemRename=l.onItemRename;this.onItemFocus=l.onItemFocus;this.onItemBlur=l.onItemBlur;this.onItemResize=l.onItemResize;this.onLineMove=l.onLineMove;this.onLineSetType=l.onLineSetType;this.onItemMark=l.onItemMark;if(l.useOperStack){this.$undoStack=[];this.$redoStack=[];this.$isUndo=0;this.pushOper=function(p,o){var n=this.$undoStack.length;if(this.$isUndo==1){this.$redoStack.push([p,o]);this.$isUndo=false;if(this.$redoStack.length>40){this.$redoStack.shift()}}else{this.$undoStack.push([p,o]);if(this.$undoStack.length>40){this.$undoStack.shift()}if(this.$isUndo==0){this.$redoStack.splice(0,this.$redoStack.length)}this.$isUndo=0}};this.pushExternalOper=function(n,o){this.pushOper("externalFunc",[n,o])};this.undo=function(){if(this.$undoStack.length==0){return}var n=this.$undoStack.pop();this.$isUndo=1;if(n[0]=="externalFunc"){n[1][0](n[1][1])}else{switch(n[1].length){case 0:this[n[0]]();break;case 1:this[n[0]](n[1][0]);break;case 2:this[n[0]](n[1][0],n[1][1]);break;case 3:this[n[0]](n[1][0],n[1][1],n[1][2]);break;case 4:this[n[0]](n[1][0],n[1][1],n[1][2],n[1][3]);break;case 5:this[n[0]](n[1][0],n[1][1],n[1][2],n[1][3],n[1][4]);break}}};this.redo=function(){if(this.$redoStack.length==0){return}var n=this.$redoStack.pop();this.$isUndo=2;if(n[0]=="externalFunc"){n[1][0](n[1][1])}else{switch(n[1].length){case 0:this[n[0]]();break;case 1:this[n[0]](n[1][0]);break;case 2:this[n[0]](n[1][0],n[1][1]);break;case 3:this[n[0]](n[1][0],n[1][1],n[1][2]);break;case 4:this[n[0]](n[1][0],n[1][1],n[1][2],n[1][3]);break;case 5:this[n[0]](n[1][0],n[1][1],n[1][2],n[1][3],n[1][4]);break}}}}}}GooFlow.prototype={useSVG:"",getSvgMarker:function(d,b){var a=document.createElementNS("http://www.w3.org/2000/svg","marker");a.setAttribute("id",d);a.setAttribute("viewBox","0 0 6 6");a.setAttribute("refX",5);a.setAttribute("refY",3);a.setAttribute("markerUnits","strokeWidth");a.setAttribute("markerWidth",6);a.setAttribute("markerHeight",6);a.setAttribute("orient","auto");var c=document.createElementNS("http://www.w3.org/2000/svg","path");c.setAttribute("d","M 0 0 L 6 3 L 0 6 z");c.setAttribute("fill",b);c.setAttribute("stroke-width",0);a.appendChild(c);return a},initDraw:function(h,e,c,g,d){var f;if(GooFlow.prototype.useSVG!=""){this.$draw=document.createElementNS("http://www.w3.org/2000/svg","svg");this.$workArea.prepend(this.$draw);var b=document.createElementNS("http://www.w3.org/2000/svg","defs");this.$draw.appendChild(b);b.appendChild(GooFlow.prototype.getSvgMarker("arrow1","#15428B"));b.appendChild(GooFlow.prototype.getSvgMarker("arrow2","#ff3300"));b.appendChild(GooFlow.prototype.getSvgMarker("arrow3","#ff3300"))}else{this.$draw=document.createElement("v:group");this.$draw.coordsize=g+","+d;this.$workArea.prepend("<div class='GooFlow_work_vml' style='position:relative;width:"+g+"px;height:"+d+"px'></div>");this.$workArea.children("div")[0].insertBefore(this.$draw,null)}this.$draw.id=h;this.$draw.style.width=g+"px";this.$draw.style.height=+d+"px";var a=null;if(GooFlow.prototype.useSVG!=""){a="g"}else{a="PolyLine"}$(this.$draw).delegate(a,"click",{inthis:this},function(j){j.data.inthis.focusItem(this.id,true)});if(this.$editable){$(this.$draw).delegate(a,"dblclick",{inthis:this},function(m){var j,q,p,r,s;var k=m.data.inthis;if(GooFlow.prototype.useSVG!=""){j=this.childNodes[2].textContent;r=this.getAttribute("from").split(",");s=this.getAttribute("to").split(",")}else{j=this.childNodes[1].innerHTML;var l=this.getAttribute("fromTo").split(",");r=[l[0],l[1]];s=[l[2],l[3]]}if(k.$lineData[this.id].type=="lr"){r[0]=k.$lineData[this.id].M;s[0]=r[0]}else{if(k.$lineData[this.id].type=="tb"){r[1]=k.$lineData[this.id].M;s[1]=r[1]}}q=(parseInt(r[0],10)+parseInt(s[0],10))/2-60;p=(parseInt(r[1],10)+parseInt(s[1],10))/2-12;var u=GooFunc.getElCoordinate(k.$workArea[0]),o=GooFunc.getElCoordinate(k.$MainContener);k.$textArea.val(j).css({display:"block",width:120,height:14,left:u.left-o.left+q-k.$workArea[0].parentNode.scrollLeft,top:u.top-o.top+p-k.$workArea[0].parentNode.scrollTop}).data("id",k.$focus).focus();k.$workArea.parent().one("mousedown",function(n){k.setName(k.$textArea.data("id"),k.$textArea.val(),"line");k.$textArea.val("").removeData("id").hide()})})}},initGroup:function(c,a,d,b){this.$group=$("<div class='GooFlow_work_group' style='width:"+d+"px;height:"+b+"px'></div>");this.$workArea.prepend(this.$group);if(!this.$editable){return}this.$group.on("mousedown",{inthis:this},function(m){var l=m.data.inthis;if(l.$nowType!="group"){return}if(l.$textArea.css("display")=="block"){l.setName(l.$textArea.data("id"),l.$textArea.val(),"area");l.$textArea.val("").removeData("id").hide();return false}if(!m){m=window.event}var r=$(m.target).css("cursor");var j=m.target.parentNode;switch(r){case"nw-resize":j=j.parentNode;break;case"w-resize":j=j.parentNode;break;case"n-resize":j=j.parentNode;break;case"move":break;default:return}j=j.id;var q=1;if(navigator.userAgent.indexOf("8.0")!=-1){q=0}var o=GooFunc.mousePosition(m),s=GooFunc.getElCoordinate(l.$workArea[0]),n=GooFunc.getElCoordinate(l.$MainContener);l.$ghost.css({display:"block",width:l.$areaData[j].width-2+"px",height:l.$areaData[j].height-2+"px",top:l.$areaData[j].top+s.top-n.top-l.$workArea[0].parentNode.scrollTop+q+"px",left:l.$areaData[j].left+s.left-n.left-l.$workArea[0].parentNode.scrollLeft+q+"px",cursor:r});var k,h;k=o.x-s.left+l.$workArea[0].parentNode.scrollLeft;h=o.y-s.top+l.$workArea[0].parentNode.scrollTop;if(r!="move"){var g=(l.$areaData[j].left+l.$areaData[j].width)-k;var f=(l.$areaData[j].top+l.$areaData[j].height)-h}else{var g=k-l.$areaData[j].left;var f=h-l.$areaData[j].top}var p=false;l.$ghost.css("cursor",r);document.onmousemove=function(u){if(!u){u=window.event}var t=GooFunc.mousePosition(u);if(r!="move"){k=t.x-s.left+l.$workArea[0].parentNode.scrollLeft-l.$areaData[j].left+g;h=t.y-s.top+l.$workArea[0].parentNode.scrollTop-l.$areaData[j].top+f;if(k<50){k=50}if(h<50){h=50}switch(r){case"nw-resize":l.$ghost.css({width:k-2+"px",height:h-2+"px"});break;case"w-resize":l.$ghost.css({width:k-2+"px"});break;case"n-resize":l.$ghost.css({height:h-2+"px"});break}}else{k=t.x-g-n.left;h=t.y-f-n.top;if(k<s.left-n.left-l.$workArea[0].parentNode.scrollLeft){k=s.left-n.left-l.$workArea[0].parentNode.scrollLeft}else{if(k+l.$workArea[0].parentNode.scrollLeft+l.$areaData[j].width>s.left-n.left+l.$workArea.width()){k=s.left-n.left+l.$workArea.width()-l.$workArea[0].parentNode.scrollLeft-l.$areaData[j].width}}if(h<s.top-n.top-l.$workArea[0].parentNode.scrollTop){h=s.top-n.top-l.$workArea[0].parentNode.scrollTop}else{if(h+l.$workArea[0].parentNode.scrollTop+l.$areaData[j].height>s.top-n.top+l.$workArea.height()){h=s.top-n.top+l.$workArea.height()-l.$workArea[0].parentNode.scrollTop-l.$areaData[j].height}}l.$ghost.css({left:k+q+"px",top:h+q+"px"})}p=true};document.onmouseup=function(t){l.$ghost.empty().hide();document.onmousemove=null;document.onmouseup=null;if(!p){return}if(r!="move"){l.resizeArea(j,l.$ghost.outerWidth(),l.$ghost.outerHeight())}else{l.moveArea(j,k+l.$workArea[0].parentNode.scrollLeft-s.left+n.left,h+l.$workArea[0].parentNode.scrollTop-s.top+n.top)}}});this.$group.on("dblclick",{inthis:this},function(k){var l=k.data.inthis;if(l.$nowType!="group"){return}if(!k){k=window.event}if(k.target.tagName!="LABEL"){return false}var h=k.target.innerHTML;var j=k.target.parentNode;var f=parseInt(j.style.left,10)+18,n=parseInt(j.style.top,10)+1;var g=GooFunc.getElCoordinate(l.$workArea[0]),m=GooFunc.getElCoordinate(l.$MainContener);l.$textArea.val(h).css({display:"block",width:100,height:14,left:g.left-m.left+f-l.$workArea[0].parentNode.scrollLeft,top:g.top-m.top+n-l.$workArea[0].parentNode.scrollTop}).data("id",j.id).focus();l.$workArea.parent().one("mousedown",function(o){if(l.$textArea.css("display")=="block"){l.setName(l.$textArea.data("id"),l.$textArea.val(),"area");l.$textArea.val("").removeData("id").hide()}});return false});this.$group.on("click",{inthis:this},function(j){var l=j.data.inthis;if(l.$nowType!="group"){return}if(!j){j=window.event}switch($(j.target).attr("class")){case"rs_close":l.delArea(j.target.parentNode.parentNode.id);return false;case"bg":return false}switch(j.target.tagName){case"LABEL":return false;case"I":var n=j.target.parentNode.id;switch(l.$areaData[n].color){case"red":l.setAreaColor(n,"yellow");break;case"yellow":l.setAreaColor(n,"blue");break;case"blue":l.setAreaColor(n,"green");break;case"green":l.setAreaColor(n,"red");break}return false}var m,k;var h=GooFunc.mousePosition(j),g=GooFunc.getElCoordinate(this);m=h.x-g.left+this.parentNode.parentNode.scrollLeft;k=h.y-g.top+this.parentNode.parentNode.scrollTop;var f=["red","yellow","blue","green"];j.data.inthis.addArea(j.data.inthis.$id+"_area_"+j.data.inthis.$max,{name:"area_"+j.data.inthis.$max,left:m,top:k,color:f[j.data.inthis.$max%4],width:200,height:100});j.data.inthis.$max++;return false})},setNodeRemarks:function(a){this.$tool.children("a").each(function(){this.title=a[$(this).attr("id").split("btn_")[1]]});this.$nodeRemark=a},switchToolBtn:function(b){this.$tool.children("#"+this.$id+"_btn_"+this.$nowType).removeClass("GooFlow_tool_btndown");if(this.$nowType=="group"){this.$workArea.prepend(this.$group);for(var a in this.$areaDom){this.$areaDom[a].addClass("lock").children("div:eq(1)").css("display","none")}}this.$nowType=b;this.$tool.children("#"+this.$id+"_btn_"+b).attr("class","GooFlow_tool_btndown");if(this.$nowType=="group"){this.blurItem();this.$workArea.append(this.$group);for(var a in this.$areaDom){this.$areaDom[a].removeClass("lock").children("div:eq(1)").css("display","")}}if(this.$textArea.css("display")=="none"){this.$textArea.removeData("id").val("").hide()}},addNode:function(e,b){if(this.onItemAdd!=null&&!this.onItemAdd(e,"node",b)){return}if(this.$undoStack){this.pushOper("delNode",[e])}var d=b.mark?" item_mark":"";if(b.type!="start"&&b.type!="end"){b.width=b.width?b.width:86;b.height=b.height?b.height:24;if(b.top<0){b.top=0}if(b.left<0){b.left=0}var c=0;if(navigator.userAgent.indexOf("8.0")!=-1){c=2}this.$nodeDom[e]=$("<div class='GooFlow_item"+d+"' id='"+e+"' style='top:"+b.top+"px;left:"+b.left+"px'><table cellspacing='1' style='width:"+(b.width-2)+"px;height:"+(b.height-2)+"px;'><tr><td class='ico'><i class='fa ico_"+b.type+"'></i></td><td>"+b.name+"</td></tr></table><div style='display:none'><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>");if(b.type=="complex"){this.$nodeDom[e].addClass("item_complex")}}else{b.width=24;b.height=24;this.$nodeDom[e]=$("<div class='GooFlow_item item_round"+d+"' id='"+e+"' style='top:"+b.top+"px;left:"+b.left+"px'><table cellspacing='0'><tr><td class='ico'><i class='fa ico_"+b.type+"'></i></td></tr></table><div  style='display:none'><div class='rs_close'></div></div><div class='span'>"+b.name+"</div></div>")}var a=navigator.userAgent.toLowerCase();if(a.indexOf("msie")!=-1&&a.indexOf("8.0")!=-1){this.$nodeDom[e].css("filter","progid:DXImageTransform.Microsoft.Shadow(color=#94AAC2,direction=135,strength=2)")}this.$workArea.append(this.$nodeDom[e]);this.$nodeData[e]=b;++this.$nodeCount},initWorkForNode:function(){this.$workArea.delegate(".GooFlow_item","click",{inthis:this},function(a){a.data.inthis.focusItem(this.id,true);$(this).removeClass("item_mark")});this.$workArea.delegate(".ico","mousedown",{inthis:this},function(k){if(!k){k=window.event}var h=k.data.inthis;if(h.$nowType=="direct"){return}var j=$(this).parents(".GooFlow_item");var f=j.attr("id");h.focusItem(f,true);var o=1;if(navigator.userAgent.indexOf("8.0")!=-1){o=0}var m=GooFunc.mousePosition(k),p=GooFunc.getElCoordinate(h.$workArea[0]),l=GooFunc.getElCoordinate(h.$MainContener);h.$ghost.css({display:"block",width:h.$nodeData[f].width-2+"px",height:h.$nodeData[f].height-2+"px",top:h.$nodeData[f].top+p.top-l.top-h.$workArea[0].parentNode.scrollTop+o+"px",left:h.$nodeData[f].left+p.left-l.left-h.$workArea[0].parentNode.scrollLeft+o+"px",cursor:"move"});j.children("table").clone().prependTo(h.$ghost);var g,d;g=m.x-p.left+h.$workArea[0].parentNode.scrollLeft;d=m.y-p.top+h.$workArea[0].parentNode.scrollTop;var b=g-h.$nodeData[f].left,a=d-h.$nodeData[f].top;var n=false;document.onmousemove=function(q){if(!q){q=window.event}var c=GooFunc.mousePosition(q);g=c.x-b-l.left;d=c.y-a-l.top;if(g<p.left-l.left-h.$workArea[0].parentNode.scrollLeft){g=p.left-l.left-h.$workArea[0].parentNode.scrollLeft}else{if(g+h.$workArea[0].parentNode.scrollLeft+h.$nodeData[f].width>p.left-l.left+h.$workArea.width()){g=p.left-l.left+h.$workArea.width()-h.$workArea[0].parentNode.scrollLeft-h.$nodeData[f].width}}if(d<p.top-l.top-h.$workArea[0].parentNode.scrollTop){d=p.top-l.top-h.$workArea[0].parentNode.scrollTop}else{if(d+h.$workArea[0].parentNode.scrollTop+h.$nodeData[f].height>p.top-l.top+h.$workArea.height()){d=p.top-l.top+h.$workArea.height()-h.$workArea[0].parentNode.scrollTop-h.$nodeData[f].height}}h.$ghost.css({left:g+o+"px",top:d+o+"px"});n=true};document.onmouseup=function(c){if(n){h.moveNode(f,g+h.$workArea[0].parentNode.scrollLeft-p.left+l.left,d+h.$workArea[0].parentNode.scrollTop-p.top+l.top)}h.$ghost.empty().hide();document.onmousemove=null;document.onmouseup=null}});if(!this.$editable){return}this.$workArea.delegate(".GooFlow_item","mouseenter",{inthis:this},function(a){if(a.data.inthis.$nowType!="direct"){return}$(this).addClass("item_mark")});this.$workArea.delegate(".GooFlow_item","mouseleave",{inthis:this},function(a){if(a.data.inthis.$nowType!="direct"){return}$(this).removeClass("item_mark")});this.$workArea.delegate(".GooFlow_item","mousedown",{inthis:this},function(d){var g=d.data.inthis;if(g.$nowType!="direct"){return}var c=GooFunc.mousePosition(d),b=GooFunc.getElCoordinate(g.$workArea[0]);var h,f;h=c.x-b.left+g.$workArea[0].parentNode.scrollLeft;f=c.y-b.top+g.$workArea[0].parentNode.scrollTop;g.$workArea.data("lineStart",{x:h,y:f,id:this.id}).css("cursor","crosshair");var a=GooFlow.prototype.drawLine("GooFlow_tmp_line",[h,f],[h,f],true,true);g.$draw.appendChild(a)});this.$workArea.delegate(".GooFlow_item","mouseup",{inthis:this},function(b){var c=b.data.inthis;if(c.$nowType!="direct"){return}var a=c.$workArea.data("lineStart");if(a){c.addLine(c.$id+"_line_"+c.$max,{from:a.id,to:this.id,name:""})}c.$max++});this.$workArea.delegate(".GooFlow_item > .span","dblclick",{inthis:this},function(d){var b=this.innerHTML;var f=d.data.inthis;var h=this.parentNode.id;var a=GooFunc.getElCoordinate(f.$workArea[0]),g=GooFunc.getElCoordinate(f.$MainContener);f.$textArea.val(b).css({display:"block",height:$(this).height(),width:100,left:a.left-g.left+f.$nodeData[h].left-f.$workArea[0].parentNode.scrollLeft-24,top:a.top-g.top+f.$nodeData[h].top-f.$workArea[0].parentNode.scrollTop+26}).data("id",f.$focus).focus();f.$workArea.parent().one("mousedown",function(c){f.setName(f.$textArea.data("id"),f.$textArea.val(),"node");f.$textArea.val("").removeData("id").hide()})});this.$workArea.delegate(".ico + td","dblclick",{inthis:this},function(d){var b=this.innerHTML;var f=d.data.inthis;var h=$(this).parents(".GooFlow_item").attr("id");var a=GooFunc.getElCoordinate(f.$workArea[0]),g=GooFunc.getElCoordinate(f.$MainContener);f.$textArea.val(b).css({display:"block",width:$(this).width()+24,height:$(this).height(),left:a.left-g.left+24+f.$nodeData[h].left-f.$workArea[0].parentNode.scrollLeft,top:a.top-g.top+2+f.$nodeData[h].top-f.$workArea[0].parentNode.scrollTop}).data("id",f.$focus).focus();f.$workArea.parent().one("mousedown",function(c){f.setName(f.$textArea.data("id"),f.$textArea.val(),"node");f.$textArea.val("").removeData("id").hide()})});this.$workArea.delegate(".rs_close","click",{inthis:this},function(a){if(!a){a=window.event}a.data.inthis.delNode(a.data.inthis.$focus);return false});this.$workArea.delegate(".GooFlow_item > div > div[class!=rs_close]","mousedown",{inthis:this},function(j){if(!j){j=window.event}var o=$(this).css("cursor");if(o=="pointer"){return}var h=j.data.inthis;var f=h.$focus;h.switchToolBtn("cursor");j.cancelBubble=true;j.stopPropagation();var n=1;if(navigator.userAgent.indexOf("8.0")!=-1){n=0}var l=GooFunc.mousePosition(j),p=GooFunc.getElCoordinate(h.$workArea[0]),k=GooFunc.getElCoordinate(h.$MainContener);h.$ghost.css({display:"block",width:h.$nodeData[f].width-2+"px",height:h.$nodeData[f].height-2+"px",top:h.$nodeData[f].top+p.top-k.top-h.$workArea[0].parentNode.scrollTop+n+"px",left:h.$nodeData[f].left+p.left-k.left-h.$workArea[0].parentNode.scrollLeft+n+"px",cursor:o});var g,d;g=l.x-p.left+h.$workArea[0].parentNode.scrollLeft;d=l.y-p.top+h.$workArea[0].parentNode.scrollTop;var b=(h.$nodeData[f].left+h.$nodeData[f].width)-g;var a=(h.$nodeData[f].top+h.$nodeData[f].height)-d;var m=false;h.$ghost.css("cursor",o);document.onmousemove=function(q){if(!q){q=window.event}var c=GooFunc.mousePosition(q);g=c.x-p.left+h.$workArea[0].parentNode.scrollLeft-h.$nodeData[f].left+b;d=c.y-p.top+h.$workArea[0].parentNode.scrollTop-h.$nodeData[f].top+a;if(g<86){g=86}if(d<24){d=24}m=true;switch(o){case"nw-resize":h.$ghost.css({width:g-2+"px",height:d-2+"px"});break;case"w-resize":h.$ghost.css({width:g-2+"px"});break;case"n-resize":h.$ghost.css({height:d-2+"px"});break}};document.onmouseup=function(c){h.$ghost.hide();if(!m){return}if(!c){c=window.event}h.resizeNode(f,h.$ghost.outerWidth(),h.$ghost.outerHeight());document.onmousemove=null;document.onmouseup=null}})},getItemInfo:function(b,a){switch(a){case"node":return this.$nodeData[b]||null;case"line":return this.$lineData[b]||null;case"area":return this.$areaData[b]||null}},blurItem:function(){if(this.$focus!=""){var a=$("#"+this.$focus);if(a.prop("tagName")=="DIV"){if(this.onItemBlur!=null&&!this.onItemBlur(id,"node")){return false}a.removeClass("item_focus").children("div:eq(0)").css("display","none")}else{if(this.onItemBlur!=null&&!this.onItemBlur(id,"line")){return false}if(GooFlow.prototype.useSVG!=""){if(!this.$lineData[this.$focus].marked){a[0].childNodes[1].setAttribute("stroke","#5068AE");a[0].childNodes[1].setAttribute("marker-end","url(#arrow1)")}}else{if(!this.$lineData[this.$focus].marked){a[0].strokeColor="#5068AE"}}this.$lineMove.hide().removeData("type").removeData("tid");if(this.$editable){this.$lineOper.hide().removeData("tid")}}}this.$focus="";return true},focusItem:function(h,b){var g=$("#"+h);if(g.length==0){return}if(!this.blurItem()){return}if(g.prop("tagName")=="DIV"){if(b&&this.onItemFocus!=null&&!this.onItemFocus(h,"node")){return}g.addClass("item_focus");if(this.$editable){g.children("div:eq(0)").css("display","block")}this.$workArea.append(g)}else{if(this.onItemFocus!=null&&!this.onItemFocus(h,"line")){return}if(GooFlow.prototype.useSVG!=""){g[0].childNodes[1].setAttribute("stroke","#ff3300");g[0].childNodes[1].setAttribute("marker-end","url(#arrow2)")}else{g[0].strokeColor="#ff3300"}if(!this.$editable){return}var a,f,e,d;if(GooFlow.prototype.useSVG!=""){e=g.attr("from").split(",");d=g.attr("to").split(",")}else{var c=g[0].getAttribute("fromTo").split(",");e=[c[0],c[1]];d=[c[2],c[3]]}e[0]=parseInt(e[0],10);e[1]=parseInt(e[1],10);d[0]=parseInt(d[0],10);d[1]=parseInt(d[1],10);if(this.$lineData[h].type=="lr"){e[0]=this.$lineData[h].M;d[0]=e[0];this.$lineMove.css({width:"5px",height:(d[1]-e[1])*(d[1]>e[1]?1:-1)+"px",left:e[0]-3+"px",top:(d[1]>e[1]?e[1]:d[1])+1+"px",cursor:"e-resize",display:"block"}).data({type:"lr",tid:h})}else{if(this.$lineData[h].type=="tb"){e[1]=this.$lineData[h].M;d[1]=e[1];this.$lineMove.css({width:(d[0]-e[0])*(d[0]>e[0]?1:-1)+"px",height:"5px",left:(d[0]>e[0]?e[0]:d[0])+1+"px",top:e[1]-3+"px",cursor:"s-resize",display:"block"}).data({type:"tb",tid:h})}}a=(e[0]+d[0])/2-35;f=(e[1]+d[1])/2+6;this.$lineOper.css({display:"block",left:a+"px",top:f+"px"}).data("tid",h)}this.$focus=h;this.switchToolBtn("cursor")},moveNode:function(d,c,b){if(!this.$nodeData[d]){return}if(this.onItemMove!=null&&!this.onItemMove(d,"node",c,b)){return}if(this.$undoStack){var a=[d,this.$nodeData[d].left,this.$nodeData[d].top];this.pushOper("moveNode",a)}if(c<0){c=0}if(b<0){b=0}$("#"+d).css({left:c+"px",top:b+"px"});this.$nodeData[d].left=c;this.$nodeData[d].top=b;this.resetLines(d,this.$nodeData[d])},setName:function(b,a,g){var c;if(g=="node"){if(!this.$nodeData[b]){return}if(this.$nodeData[b].name==a){return}if(this.onItemRename!=null&&!this.onItemRename(b,a,"node")){return}c=this.$nodeData[b].name;this.$nodeData[b].name=a;if(this.$nodeData[b].type=="start"||this.$nodeData[b].type=="end"){this.$nodeDom[b].children(".span").text(a)}else{this.$nodeDom[b].find("td:eq(1)").text(a);var j=0;if(navigator.userAgent.indexOf("8.0")!=-1){j=2}var d=this.$nodeDom[b].outerWidth();var k=this.$nodeDom[b].outerHeight();this.$nodeDom[b].children("table").css({width:d-2+"px",height:k-2+"px"});this.$nodeData[b].width=d;this.$nodeData[b].height=k}this.resetLines(b,this.$nodeData[b])}else{if(g=="line"){if(!this.$lineData[b]){return}if(this.$lineData[b].name==a){return}if(this.onItemRename!=null&&!this.onItemRename(b,a,"line")){return}c=this.$lineData[b].name;this.$lineData[b].name=a;if(GooFlow.prototype.useSVG!=""){this.$lineDom[b].childNodes[2].textContent=a}else{this.$lineDom[b].childNodes[1].innerHTML=a;var e=this.$lineDom[b].getAttribute("fromTo").split(",");var h;if(this.$lineData[b].type!="lr"){h=(e[2]-e[0])/2}else{var f=e[2]>e[0]?e[0]:e[2];if(f>this.$lineData[b].M){f=this.$lineData[b].M}h=this.$lineData[b].M-f}if(h<0){h=h*-1}this.$lineDom[b].childNodes[1].style.left=h-this.$lineDom[b].childNodes[1].offsetWidth/2+4+"px"}}else{if(g=="area"){if(!this.$areaData[b]){return}if(this.$areaData[b].name==a){return}if(this.onItemRename!=null&&!this.onItemRename(b,a,"area")){return}c=this.$areaData[b].name;this.$areaData[b].name=a;this.$areaDom[b].children("label").text(a)}}}if(this.$undoStack){var l=[b,c,g];this.pushOper("setName",l)}},setNodeType:function(d,b,c){if(!this.$nodeData[d]){return}if(this.$nodeData[d].type!=b){return}if(this.$nodeData[d].type==c){return}if(this.$nodeData[d].type=="start"||this.$nodeData[d].type=="end"){return}if(c=="start"||c=="end"){return}this.$nodeData[d].type=c;this.$nodeDom[d].find(".ico").children("i").removeClass("ico_"+b).addClass("ico_"+c);if(this.$undoStack){var a=[d,c,b];this.pushOper("setNodeType",a)}},resizeNode:function(e,c,a){if(!this.$nodeData[e]){return}if(this.onItemResize!=null&&!this.onItemResize(e,"node",c,a)){return}if(this.$nodeData[e].type=="start"||this.$nodeData[e].type=="end"){return}if(this.$undoStack){var b=[e,this.$nodeData[e].width,this.$nodeData[e].height];this.pushOper("resizeNode",b)}var d=0;if(navigator.userAgent.indexOf("8.0")!=-1){d=2}this.$nodeDom[e].children("table").css({width:c-2+"px",height:a-2+"px"});c=this.$nodeDom[e].outerWidth()-d;a=this.$nodeDom[e].outerHeight()-d;this.$nodeDom[e].children("table").css({width:c-2+"px",height:a-2+"px"});this.$nodeData[e].width=c;this.$nodeData[e].height=a;this.resetLines(e,this.$nodeData[e])},delNode:function(c){if(!this.$nodeData[c]){return}if(this.$undoStack){var b=[c,this.$nodeData[c]];this.pushOper("addNode",b)}if(this.onItemDel!=null&&!this.onItemDel(c,"node")){return}delete this.$nodeData[c];this.$nodeDom[c].remove();delete this.$nodeDom[c];--this.$nodeCount;if(this.$focus==c){this.$focus=""}for(var a in this.$lineData){if(this.$lineData[a].from==c||this.$lineData[a].to==c){this.$draw.removeChild(this.$lineDom[a]);delete this.$lineData[a];delete this.$lineDom[a]}}},setTitle:function(a){this.$title=a;if(this.$head){this.$head.children("label").attr("title",a).text(a)}},loadData:function(e){this.setTitle(e.title);if(e.initNum){this.$max=e.initNum}for(var d in e.nodes){this.addNode(d,e.nodes[d]);var a=d.split(this.$id+"_node_")[1]*1;if(a&&this.$max<a){this.$max=a}}for(var c in e.lines){this.addLine(c,e.lines[c]);var a=c.split(this.$id+"_line_")[1]*1;if(a&&this.$max<a){this.$max=a}}for(var b in e.areas){this.addArea(b,e.areas[b]);var a=b.split(this.$id+"_area_")[1]*1;if(a&&this.$max<a){this.$max=a}}this.$max++},loadDataAjax:function(a){var b=this;$.ajax({type:a.type,url:a.url,dataType:"json",data:a.data,success:function(c){if(a.dataFilter){a.dataFilter(c,"json")}b.loadData(c);if(a.success){a.success(c)}},error:function(c,e,d){if(a.error){a.error(e,d)}}})},exportData:function(){return{nodes:this.$nodeData,lines:this.$lineData,areas:this.$areaData}},clearData:function(){for(var a in this.$nodeData){this.delNode(a)}for(var a in this.$lineData){this.delLine(a)}for(var a in this.$areaData){this.delArea(a)}},destrory:function(){this.$bgDiv.empty();this.$lineData=null;this.$nodeData=null;this.$lineDom=null;this.$nodeDom=null;this.$areaDom=null;this.$areaData=null;this.$nodeCount=0;this.$areaCount=0;this.$areaCount=0},drawLine:function(a,b,k,d,e){var l;if(GooFlow.prototype.useSVG!=""){l=document.createElementNS("http://www.w3.org/2000/svg","g");var c=document.createElementNS("http://www.w3.org/2000/svg","path");var j=document.createElementNS("http://www.w3.org/2000/svg","path");if(a!=""){l.setAttribute("id",a)}l.setAttribute("from",b[0]+","+b[1]);l.setAttribute("to",k[0]+","+k[1]);c.setAttribute("visibility","hidden");c.setAttribute("stroke-width",9);c.setAttribute("fill","none");c.setAttribute("stroke","white");c.setAttribute("d","M "+b[0]+" "+b[1]+" L "+k[0]+" "+k[1]);c.setAttribute("pointer-events","stroke");j.setAttribute("d","M "+b[0]+" "+b[1]+" L "+k[0]+" "+k[1]);j.setAttribute("stroke-width",1.4);j.setAttribute("stroke-linecap","round");j.setAttribute("fill","none");if(e){j.setAttribute("style","stroke-dasharray:6,5")}if(d){j.setAttribute("stroke","#ff3300");j.setAttribute("marker-end","url(#arrow2)")}else{j.setAttribute("stroke","#5068AE");j.setAttribute("marker-end","url(#arrow1)")}l.appendChild(c);l.appendChild(j);l.style.cursor="crosshair";if(a!=""&&a!="GooFlow_tmp_line"){var h=document.createElementNS("http://www.w3.org/2000/svg","text");l.appendChild(h);var g=(k[0]+b[0])/2;var f=(k[1]+b[1])/2;h.setAttribute("text-anchor","middle");h.setAttribute("x",g);h.setAttribute("y",f);l.style.cursor="pointer";h.style.cursor="text"}}else{l=document.createElement("v:polyline");if(a!=""){l.id=a}l.points.value=b[0]+","+b[1]+" "+k[0]+","+k[1];l.setAttribute("fromTo",b[0]+","+b[1]+","+k[0]+","+k[1]);l.strokeWeight="1.2";l.stroke.EndArrow="Block";l.style.cursor="crosshair";if(a!=""&&a!="GooFlow_tmp_line"){var h=document.createElement("div");l.appendChild(h);var g=(k[0]-b[0])/2;var f=(k[1]-b[1])/2;if(g<0){g=g*-1}if(f<0){f=f*-1}h.style.left=g+"px";h.style.top=f-6+"px";l.style.cursor="pointer"}if(e){l.stroke.dashstyle="Dash"}if(d){l.strokeColor="#ff3300"}else{l.strokeColor="#5068AE"}}return l},drawPoly:function(b,c,l,k,n,e){var a,f;if(GooFlow.prototype.useSVG!=""){a=document.createElementNS("http://www.w3.org/2000/svg","g");var d=document.createElementNS("http://www.w3.org/2000/svg","path");var m=document.createElementNS("http://www.w3.org/2000/svg","path");if(b!=""){a.setAttribute("id",b)}a.setAttribute("from",c[0]+","+c[1]);a.setAttribute("to",n[0]+","+n[1]);d.setAttribute("visibility","hidden");d.setAttribute("stroke-width",9);d.setAttribute("fill","none");d.setAttribute("stroke","white");f="M "+c[0]+" "+c[1];if(l[0]!=c[0]||l[1]!=c[1]){f+=" L "+l[0]+" "+l[1]}if(k[0]!=n[0]||k[1]!=n[1]){f+=" L "+k[0]+" "+k[1]}f+=" L "+n[0]+" "+n[1];d.setAttribute("d",f);d.setAttribute("pointer-events","stroke");m.setAttribute("d",f);m.setAttribute("stroke-width",1.4);m.setAttribute("stroke-linecap","round");m.setAttribute("fill","none");if(e){m.setAttribute("stroke","#ff3300");m.setAttribute("marker-end","url(#arrow2)")}else{m.setAttribute("stroke","#5068AE");m.setAttribute("marker-end","url(#arrow1)")}a.appendChild(d);a.appendChild(m);var j=document.createElementNS("http://www.w3.org/2000/svg","text");a.appendChild(j);var h=(k[0]+l[0])/2;var g=(k[1]+l[1])/2;j.setAttribute("text-anchor","middle");j.setAttribute("x",h);j.setAttribute("y",g);j.style.cursor="text";a.style.cursor="pointer"}else{a=document.createElement("v:Polyline");if(b!=""){a.id=b}a.filled="false";f=c[0]+","+c[1];if(l[0]!=c[0]||l[1]!=c[1]){f+=" "+l[0]+","+l[1]}if(k[0]!=n[0]||k[1]!=n[1]){f+=" "+k[0]+","+k[1]}f+=" "+n[0]+","+n[1];a.points.value=f;a.setAttribute("fromTo",c[0]+","+c[1]+","+n[0]+","+n[1]);a.strokeWeight="1.2";a.stroke.EndArrow="Block";var j=document.createElement("div");a.appendChild(j);var h=(k[0]-l[0])/2;var g=(k[1]-l[1])/2;if(h<0){h=h*-1}if(g<0){g=g*-1}j.style.left=h+"px";j.style.top=g-4+"px";a.style.cursor="pointer";if(e){a.strokeColor="#ff3300"}else{a.strokeColor="#5068AE"}}return a},calcStartEnd:function(h,g){if(!h||!g){return{start:[],end:[]}}var o,d,n,c;var m=h.left,l=h.left+h.width,f=g.left,e=g.left+g.width;if(m>=e){o=m;n=e}else{if(l<=f){o=l;n=f}else{if(m<=f&&l>=f&&l<=e){o=(l+f)/2;n=o}else{if(m>=f&&l<=e){o=(m+l)/2;n=o}else{if(f>=m&&e<=l){o=(f+e)/2;n=o}else{if(m<=e&&l>=e){o=(m+e)/2;n=o}}}}}}var b=h.top,a=h.top+h.height,k=g.top,j=g.top+g.height;if(b>=j){d=b;c=j}else{if(a<=k){d=a;c=k}else{if(b<=k&&a>=k&&a<=j){d=(a+k)/2;c=d}else{if(b>=k&&a<=j){d=(b+a)/2;c=d}else{if(k>=b&&j<=a){d=(k+j)/2;c=d}else{if(b<=j&&a>=j){d=(b+j)/2;c=d}}}}}}return{start:[o,d],end:[n,c]}},calcPolyPoints:function(d,c,g,e){var f={x:d.left+d.width/2,y:d.top+d.height/2};var b={x:c.left+c.width/2,y:c.top+c.height/2};var a=[],j=[],h=[],k=[];a=[f.x,f.y];k=[b.x,b.y];if(g=="lr"){j=[e,f.y];h=[e,b.y];if(j[0]>d.left&&j[0]<d.left+d.width){j[1]=(f.y>b.y?d.top:d.top+d.height);a[0]=j[0];a[1]=j[1]}else{a[0]=(j[0]<d.left?d.left:d.left+d.width)}if(h[0]>c.left&&h[0]<c.left+c.width){h[1]=(f.y>b.y?c.top+c.height:c.top);k[0]=h[0];k[1]=h[1]}else{k[0]=(h[0]<c.left?c.left:c.left+c.width)}}else{if(g=="tb"){j=[f.x,e];h=[b.x,e];if(j[1]>d.top&&j[1]<d.top+d.height){j[0]=(f.x>b.x?d.left:d.left+d.width);a[0]=j[0];a[1]=j[1]}else{a[1]=(j[1]<d.top?d.top:d.top+d.height)}if(h[1]>c.top&&h[1]<c.top+c.height){h[0]=(f.x>b.x?c.left+c.width:c.left);k[0]=h[0];k[1]=h[1]}else{k[1]=(h[1]<c.top?c.top:c.top+c.height)}}}return{start:a,m1:j,m2:h,end:k}},getMValue:function(b,a,c){if(c=="lr"){return(b.left+b.width/2+a.left+a.width/2)/2}else{if(c=="tb"){return(b.top+b.height/2+a.top+a.height/2)/2}}},addLine:function(g,e){if(this.onItemAdd!=null&&!this.onItemAdd(g,"line",e)){return}if(this.$undoStack){this.pushOper("delLine",[g])}var f=null,d=null;if(e.from==e.to){return}for(var b in this.$lineData){if((e.from==this.$lineData[b].from&&e.to==this.$lineData[b].to)){return}}var f=this.$nodeData[e.from],d=this.$nodeData[e.to];if(!f||!d){return}var c;if(e.type&&e.type!="sl"){c=GooFlow.prototype.calcPolyPoints(f,d,e.type,e.M)}else{c=GooFlow.prototype.calcStartEnd(f,d)}if(!c){return}this.$lineData[g]={};if(e.type){this.$lineData[g].type=e.type;this.$lineData[g].M=e.M}else{this.$lineData[g].type="sl"}this.$lineData[g].from=e.from;this.$lineData[g].to=e.to;this.$lineData[g].name=e.name;if(e.mark){this.$lineData[g].marked=e.mark}else{this.$lineData[g].marked=false}if(this.$lineData[g].type=="sl"){this.$lineDom[g]=GooFlow.prototype.drawLine(g,c.start,c.end,e.mark)}else{this.$lineDom[g]=GooFlow.prototype.drawPoly(g,c.start,c.m1,c.m2,c.end,e.mark)}this.$draw.appendChild(this.$lineDom[g]);if(GooFlow.prototype.useSVG==""){this.$lineDom[g].childNodes[1].innerHTML=e.name;if(this.$lineData[g].type!="sl"){var a=(c.start[0]>c.end[0]?c.end[0]:c.start[0]);if(a>c.m2[0]){a=c.m2[0]}if(a>c.m1[0]){a=c.m1[0]}this.$lineDom[i].childNodes[1].style.left=(c.m2[0]+c.m1[0])/2-a-this.$lineDom[g].childNodes[1].offsetWidth/2+4;a=(c.start[1]>c.end[1]?c.end[1]:c.start[1]);if(a>c.m2[1]){a=c.m2[1]}if(a>c.m1[1]){a=c.m1[1]}this.$lineDom[g].childNodes[1].style.top=(c.m2[1]+c.m1[1])/2-a-this.$lineDom[g].childNodes[1].offsetHeight/2}else{this.$lineDom[g].childNodes[1].style.left=((c.end[0]-c.start[0])*(c.end[0]>c.start[0]?1:-1)-this.$lineDom[g].childNodes[1].offsetWidth)/2+4}}else{this.$lineDom[g].childNodes[2].textContent=e.name}++this.$lineCount},resetLines:function(f,e){for(var d in this.$lineData){var b=null;var c;if(this.$lineData[d].from==f){b=this.$nodeData[this.$lineData[d].to]||null;if(b==null){continue}if(this.$lineData[d].type=="sl"){c=GooFlow.prototype.calcStartEnd(e,b)}else{c=GooFlow.prototype.calcPolyPoints(e,b,this.$lineData[d].type,this.$lineData[d].M)}if(!c){break}}else{if(this.$lineData[d].to==f){b=this.$nodeData[this.$lineData[d].from]||null;if(b==null){continue}if(this.$lineData[d].type=="sl"){c=GooFlow.prototype.calcStartEnd(b,e)}else{c=GooFlow.prototype.calcPolyPoints(b,e,this.$lineData[d].type,this.$lineData[d].M)}if(!c){break}}}if(b==null){continue}this.$draw.removeChild(this.$lineDom[d]);if(this.$lineData[d].type=="sl"){this.$lineDom[d]=GooFlow.prototype.drawLine(d,c.start,c.end,this.$lineData[d].marked)}else{this.$lineDom[d]=GooFlow.prototype.drawPoly(d,c.start,c.m1,c.m2,c.end,this.$lineData[d].marked)}this.$draw.appendChild(this.$lineDom[d]);if(GooFlow.prototype.useSVG==""){this.$lineDom[d].childNodes[1].innerHTML=this.$lineData[d].name;if(this.$lineData[d].type!="sl"){var a=(c.start[0]>c.end[0]?c.end[0]:c.start[0]);if(a>c.m2[0]){a=c.m2[0]}if(a>c.m1[0]){a=c.m1[0]}this.$lineDom[d].childNodes[1].style.left=(c.m2[0]+c.m1[0])/2-a-this.$lineDom[d].childNodes[1].offsetWidth/2+4;a=(c.start[1]>c.end[1]?c.end[1]:c.start[1]);if(a>c.m2[1]){a=c.m2[1]}if(a>c.m1[1]){a=c.m1[1]}this.$lineDom[d].childNodes[1].style.top=(c.m2[1]+c.m1[1])/2-a-this.$lineDom[d].childNodes[1].offsetHeight/2-4}else{this.$lineDom[d].childNodes[1].style.left=((c.end[0]-c.start[0])*(c.end[0]>c.start[0]?1:-1)-this.$lineDom[d].childNodes[1].offsetWidth)/2+4}}else{this.$lineDom[d].childNodes[2].textContent=this.$lineData[d].name}}},setLineType:function(g,c){if(!c||c==null||c==""||c==this.$lineData[g].type){return false}if(this.onLineSetType!=null&&!this.onLineSetType(g,c)){return}if(this.$undoStack){var b=[g,this.$lineData[g].type];this.pushOper("setLineType",b);if(this.$lineData[g].type!="sl"){var a=[g,this.$lineData[g].M];this.pushOper("setLineM",a)}}var f=this.$lineData[g].from;var e=this.$lineData[g].to;this.$lineData[g].type=c;var d;if(c!="sl"){var d=GooFlow.prototype.calcPolyPoints(this.$nodeData[f],this.$nodeData[e],this.$lineData[g].type,this.$lineData[g].M);this.setLineM(g,this.getMValue(this.$nodeData[f],this.$nodeData[e],c),true)}else{delete this.$lineData[g].M;this.$lineMove.hide().removeData("type").removeData("tid");d=GooFlow.prototype.calcStartEnd(this.$nodeData[f],this.$nodeData[e]);if(!d){return}this.$draw.removeChild(this.$lineDom[g]);this.$lineDom[g]=GooFlow.prototype.drawLine(g,d.start,d.end,this.$lineData[g].marked||this.$focus==g);this.$draw.appendChild(this.$lineDom[g]);if(GooFlow.prototype.useSVG==""){this.$lineDom[g].childNodes[1].innerHTML=this.$lineData[g].name;this.$lineDom[g].childNodes[1].style.left=((d.end[0]-d.start[0])*(d.end[0]>d.start[0]?1:-1)-this.$lineDom[g].childNodes[1].offsetWidth)/2+4}else{this.$lineDom[g].childNodes[2].textContent=this.$lineData[g].name}}if(this.$focus==g){this.focusItem(g)}},setLineM:function(h,g,d){if(!this.$lineData[h]||g<0||!this.$lineData[h].type||this.$lineData[h].type=="sl"){return false}if(this.onLineMove!=null&&!this.onLineMove(h,g)){return false}if(this.$undoStack&&!d){var b=[h,this.$lineData[h].M];this.pushOper("setLineM",b)}var f=this.$lineData[h].from;var e=this.$lineData[h].to;this.$lineData[h].M=g;var c=GooFlow.prototype.calcPolyPoints(this.$nodeData[f],this.$nodeData[e],this.$lineData[h].type,this.$lineData[h].M);this.$draw.removeChild(this.$lineDom[h]);this.$lineDom[h]=GooFlow.prototype.drawPoly(h,c.start,c.m1,c.m2,c.end,this.$lineData[h].marked||this.$focus==h);this.$draw.appendChild(this.$lineDom[h]);if(GooFlow.prototype.useSVG==""){this.$lineDom[h].childNodes[1].innerHTML=this.$lineData[h].name;var a=(c.start[0]>c.end[0]?c.end[0]:c.start[0]);if(a>c.m2[0]){a=c.m2[0]}if(a>c.m1[0]){a=c.m1[0]}this.$lineDom[h].childNodes[1].style.left=(c.m2[0]+c.m1[0])/2-a-this.$lineDom[h].childNodes[1].offsetWidth/2+4;a=(c.start[1]>c.end[1]?c.end[1]:c.start[1]);if(a>c.m2[1]){a=c.m2[1]}if(a>c.m1[1]){a=c.m1[1]}this.$lineDom[h].childNodes[1].style.top=(c.m2[1]+c.m1[1])/2-a-this.$lineDom[h].childNodes[1].offsetHeight/2-4}else{this.$lineDom[h].childNodes[2].textContent=this.$lineData[h].name}},delLine:function(b){if(!this.$lineData[b]){return}if(this.onItemDel!=null&&!this.onItemDel(b,"line")){return}if(this.$undoStack){var a=[b,this.$lineData[b]];this.pushOper("addLine",a)}this.$draw.removeChild(this.$lineDom[b]);delete this.$lineData[b];delete this.$lineDom[b];if(this.$focus==b){this.$focus=""}--this.$lineCount},markItem:function(e,c,d,a){if(null==a){a="#ff3300"}if(c=="node"){if(!this.$nodeData[e]){return}if(this.onItemMark!=null&&!this.onItemMark(e,"node",d)){return}this.$nodeData[e].marked=d||false;if(d){this.$nodeDom[e].css("background",a);this.$nodeDom[e].css("border",a+" 1px solid")}else{this.$nodeDom[e].removeClass("item_mark")}}else{if(c=="line"){if(!this.$lineData[e]){return}if(this.onItemMark!=null&&!this.onItemMark(e,"line",d)){return}this.$lineData[e].marked=d||false;if(GooFlow.prototype.useSVG!=""){if(d){this.$lineDom[e].childNodes[1].setAttribute("stroke",a);this.$lineDom[e].childNodes[1].removeAttribute("marker-end")}else{this.$lineDom[e].childNodes[1].setAttribute("stroke","#5068AE");this.$lineDom[e].childNodes[1].setAttribute("marker-end","url(#arrow1)")}}else{if(d){this.$lineDom[e].strokeColor=a}else{this.$lineDom[e].strokeColor="#5068AE"}}}}if(this.$undoStatck){var b=[e,c,!d];this.pushOper("markItem",b)}},moveArea:function(d,c,b){if(!this.$areaData[d]){return}if(this.onItemMove!=null&&!this.onItemMove(d,"area",c,b)){return}if(this.$undoStack){var a=[d,this.$areaData[d].left,this.$areaData[d].top];this.pushOper("moveNode",a)}if(c<0){c=0}if(b<0){b=0}$("#"+d).css({left:c+"px",top:b+"px"});this.$areaData[d].left=c;this.$areaData[d].top=b},delArea:function(b){if(!this.$areaData[b]){return}if(this.$undoStack){var a=[b,this.$areaData[b]];this.pushOper("addArea",a)}if(this.onItemDel!=null&&!this.onItemDel(b,"area")){return}delete this.$areaData[b];this.$areaDom[b].remove();delete this.$areaDom[b];--this.$areaCount},setAreaColor:function(c,a){if(!this.$areaData[c]){return}if(this.$undoStack){var b=[c,this.$areaData[c].color];this.pushOper("setAreaColor",b)}if(a=="red"||a=="yellow"||a=="blue"||a=="green"){this.$areaDom[c].removeClass("area_"+this.$areaData[c].color).addClass("area_"+a);this.$areaData[c].color=a}},resizeArea:function(e,c,a){if(!this.$areaData[e]){return}if(this.onItemResize!=null&&!this.onItemResize(e,"area",c,a)){return}if(this.$undoStack){var b=[e,this.$areaData[e].width,this.$areaData[e].height];this.pushOper("resizeArea",b)}var d=0;if(navigator.userAgent.indexOf("8.0")!=-1){d=2}this.$areaDom[e].children(".bg").css({width:c-2+"px",height:a-2+"px"});c=this.$areaDom[e].outerWidth();a=this.$areaDom[e].outerHeight();this.$areaDom[e].children("bg").css({width:c-2+"px",height:a-2+"px"});this.$areaData[e].width=c;this.$areaData[e].height=a},addArea:function(b,a){if(this.onItemAdd!=null&&!this.onItemAdd(b,"area",a)){return}if(this.$undoStack){this.pushOper("delArea",[b])}this.$areaDom[b]=$("<div id='"+b+"' class='GooFlow_area area_"+a.color+"' style='top:"+a.top+"px;left:"+a.left+"px'><div class='bg' style='width:"+(a.width-2)+"px;height:"+(a.height-2)+"px'></div><label>"+a.name+"</label><i class='fa' title='点击变换颜色'></i><div><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>");this.$areaData[b]=a;this.$group.append(this.$areaDom[b]);if(this.$nowType!="group"){this.$areaDom[b].children("div:eq(1)").css("display","none")}++this.$areaCount},reinitSize:function(d,a){var b=(d||800)-2;var c=(a||500)-2;this.$bgDiv.css({height:c+"px",width:b+"px"});var f=0,e=10;if(this.$head!=null){f=24;e=7}if(this.$tool!=null){this.$tool.css({height:c-f-e+"px"})}b-=39;c=c-f-(this.$head!=null?5:8);this.$workArea.parent().css({height:c+"px",width:b+"px"});this.$workArea.css({height:c*2+"px",width:b*2+"px"})}};$.fn.extend({createGooFlow:function(c){var a={id:"",MainContener:$("body")[0],width:"auto",height:500,initNum:1,initLabelText:"newFlow_1",workWidth:null,workHeight:null,toolBtns:["start","end","fork","join","complex","node","task","chat","state","plug"],toolBtnRemarks:{cursor:"选择指针",direct:"连线",start:"开始结点",end:"结束结点",task:"任务结点",node:"自动结点",chat:"决策结点",state:"状态结点",plug:"附加插件",fork:"分支结点",join:"联合结点",complex:"复合结点",group:"组织划分框编辑开关"},haveHead:true,headBtns:["new","open","save","undo","redo","reload","expand"],headBtnRemarks:["新建","打开","保存","撤销","重做","重置画布","扩大画布"],haveTool:true,haveGroup:true,useOperStack:true,editable:true,onBtnNewClick:null,onBtnOpenClick:null,onBtnSaveClick:null,onFreshClick:null,onExpandClick:null,onItemAdd:null,onItemDel:null,onItemMove:null,onItemRename:null,onItemFocus:null,onItemBlur:null,onItemResize:null,onLineMove:null,onLineSetType:null,onItemMark:null},b;b=$.extend({},a,c);return new GooFlow(this,b)}});